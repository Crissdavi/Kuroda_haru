import fs from 'fs';
import path from 'path';

const mascotasFile = path.resolve('src/database/mascotas.json');

function loadMascotas() {
    try {
        return fs.existsSync(mascotasFile) ? JSON.parse(fs.readFileSync(mascotasFile, 'utf8')) : {};
    } catch (error) {
        console.error('Error loading mascotas:', error);
        return {};
    }
}

function saveMascotas(data) {
    try {
        fs.writeFileSync(mascotasFile, JSON.stringify(data, null, 2));
    } catch (error) {
        console.error('Error saving mascotas:', error);
    }
}

function verificarNivel(userId, mascotas) {
    const mascota = mascotas[userId];
    const expNecesaria = mascota.nivel * 100;
    
    if (mascota.experiencia >= expNecesaria) {
        const viejoNivel = mascota.nivel;
        mascota.nivel++;
        mascota.experiencia = 0;
        return viejoNivel;
    }
    return null;
}

const handler = async (m, { conn, usedPrefix }) => {
    const userId = m.sender;
    let mascotas = loadMascotas();

    if (!mascotas[userId]) {
        return await conn.reply(m.chat, 
            `✧ No tienes una mascota.\n` +
            `✧ Usa *${usedPrefix}adoptar* para obtener una.`, m);
    }

    const mascota = mascotas[userId];

    if (mascota.hambre >= 100) {
        return await conn.reply(m.chat, 
            `✧ ${mascota.nombre} ya está lleno! 🍖\n` +
            `✧ Espera a que tenga hambre.`, m);
    }

    // Alimentar mascota
    mascota.hambre = Math.min(100, mascota.hambre + 30);
    mascota.experiencia += 15;
    mascota.estadisticas.alimentado++;
    
    const subioNivel = verificarNivel(userId, mascotas);
    
    let mensaje = `🍖 ¡Le diste de comer a *${mascota.nombre}*!\n` +
                 `✧ Hambre: +30%\n` +
                 `✧ EXP: +15`;
    
    if (subioNivel) {
        mensaje += `\n\n🎉 *¡NIVEL SUBIDO!* ${subioNivel} → ${mascota.nivel}\n` +
                  `✨ ¡${mascota.nombre} está más fuerte!`;
    }

    saveMascotas(mascotas);
    await conn.reply(m.chat, mensaje, m);
};

handler.tags = ['rpg', 'mascotas'];
handler.help = ['alimentar - Alimentar a tu mascota'];
handler.command = ['alimentar', 'feed', 'comida'];

export default handler;